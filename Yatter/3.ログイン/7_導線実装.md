# 導線実装

ログイン画面とパブリックタイムライン画面の導線実装を行います。
アプリを起動した時の挙動を変更します。

Yatterアプリで既にログインしていればアプリ起動時にはそのままパブリックタイムライン画面に遷移し、一度もログインしていなければログイン画面に遷移します。

ログイン済みかどうかを判定するために`CheckLoginService`を新規作成し、`MainViewModel`でログイン状況を確認して遷移する画面を制御します。

まずは`CheckLoginService`の実装からです。
`CheckLoginService`はDomainServiceにあたるため、`domain/service`パッケージにinterfaceを定義し`infra/domain/service`に実装クラスを配置します。

```Kotlin
// domain/service/CheckLoginService.kt

interface CheckLoginService {
  suspend fun execute(): Boolean
}

// infra/domain/service/CheckLoginServiceImpl.kt

internal class CheckLoginServiceImpl(
  private val mePreferences: MePreferencese,
) : CheckLoginService {
  override suspend fun execute(): Boolean {
    return mePreferences.getUsername() != ""
  }
}
```

続いてViewModelの実装を行います。

ログイン画面実装の際に行なったように遷移用の`SingleLiveEvent`の値を定義します。
遷移先は、ログイン画面とパブリックタイムライン画面です。

```Kotlin
private val _navigateToLogin: SingleLiveEvent<Unit> = SingleLiveEvent()
val navigateToLogin: LiveData<Unit> = _navigateToLogin

private val _navigateToPublicTimeline: SingleLiveEvent<Unit> = SingleLiveEvent()
val navigateToPublicTimeline: LiveData<Unit> = _navigateToPublicTimeline
```

遷移用の値が作成できたため、ViewModel初期化時にログイン状況を確認して遷移用の値を流します。

```Kotlin
init {
  viewModelScope.launch {
    if (checkLoginService.execute()) {
      _navigateToPublicTimeline.value = Unit
    } else {
      _navigateToLogin.value = Unit
    }
  }
}
```

ViewModelから遷移用の値を公開できたら今度はActivity側で購読します。

```Kotlin
class MainActivity : AppCompatActivity() {
  private val viewModel: MainViewModel by viewModel()

  override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)
    
    ...

    viewModel.navigateToPublicTimeline.observe(this) {
      startActivity(PublicTimelineActivity.newIntent(this))
      finish()
    }

    viewModel.navigateToLogin.observe(this) {
      startActivity(LoginActivity.newIntent(this))
      finish()
    }
  }
}
```

これらの実装によりログイン状況に応じてアプリ起動時に表示される画面を分岐することができました。
エミュレータで実際にYatterアプリを実装してみて動作を確認してみてください。
一度ログインした後に再度ログイン画面を表示させたいときはアプリを再インストールすることでログイン画面から再度動作を確認できます。
